<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - Relatório de Anúncios do Facebook</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <h1>Login</h1>
        <button id="fbLoginButton">Login com Facebook</button>
    </div>

    <!-- SDK do Facebook -->
    <script async defer crossorigin="anonymous" src="https://connect.facebook.net/en_US/sdk.js"></script>
    <script>
        window.fbAsyncInit = function() {
            FB.init({
                appId: '618519427538646',
                cookie: true,
                xfbml: true,
                version: 'v20.0'
            });
            FB.AppEvents.logPageView();
            console.log("Facebook SDK inicializado com sucesso!");

            // Verifica o status de login ao carregar a página
            FB.getLoginStatus(function(response) {
                if (response.status === 'connected') {
                    console.log('Usuário já está logado:', response);
                    localStorage.setItem('fbAccessToken', response.authResponse.accessToken);
                    fetchAdAccounts(response.authResponse.accessToken);
                    window.location.href = 'index.html?screen=reportSelection';
                }
            });
        };

        // Função para login com Facebook
        function fbLogin() {
            FB.login(function(response) {
                if (response.authResponse) {
                    console.log('Login bem-sucedido:', response);
                    const accessToken = response.authResponse.accessToken;
                    localStorage.setItem('fbAccessToken', accessToken);
                    fetchAdAccounts(accessToken);
                    window.location.href = 'index.html?screen=reportSelection';
                } else {
                    console.log('Usuário cancelou o login ou não autorizou completamente.');
                }
            }, { scope: 'ads_read' });
        }

        // Função para buscar contas de anúncios
        function fetchAdAccounts(accessToken) {
            FB.api('/me/adaccounts', { fields: 'id,name', access_token: accessToken }, function(response) {
                if (response && !response.error) {
                    console.log('Contas de anúncios recebidas:', response);
                    const adAccountsMap = {};
                    response.data.forEach(account => {
                        adAccountsMap[account.id] = account.name;
                    });
                    localStorage.setItem('adAccountsMap', JSON.stringify(adAccountsMap));
                } else {
                    console.error('Erro ao buscar contas de anúncios:', response.error);
                }
            });
        }

        // Associar o evento ao botão de login
        document.getElementById('fbLoginButton').addEventListener('click', fbLogin);
    </script>
</body>
</html>